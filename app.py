# app.py (ê³¼ëª© ì„ íƒ + ë””ë²„ê¹… í¬í•¨ + í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°)

import streamlit as st
from datetime import datetime
import json
from drive_handler import get_drive_service_from_secrets, get_current_week, get_weekly_files
from gpt_brief import generate_brief
from audio_utils import text_to_audio

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. í•™ìŠµì ì •ë³´ ì…ë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.title("ğŸ§ ë°ì¼ë¦¬ í•™ìŠµ ë¸Œë¦¬í•‘ íŒŸìºìŠ¤íŠ¸")

with st.form("user_form"):
    st.subheader("ğŸ‘¤ í•™ìŠµì ì •ë³´ ì…ë ¥")
    user_name = st.text_input("ì´ë¦„")
    user_grade = st.selectbox("í•™ë…„", ["1í•™ë…„", "2í•™ë…„", "3í•™ë…„", "4í•™ë…„"])
    user_major = st.text_input("ì „ê³µ")
    user_style = st.selectbox("í•™ìŠµ ìŠ¤íƒ€ì¼", ["ê°œë… ì¤‘ì‹¬", "ì‚¬ë¡€ ì¤‘ì‹¬", "í‚¤ì›Œë“œ ìš”ì•½", "ìŠ¤í† ë¦¬í…”ë§"])
    submitted = st.form_submit_button("ì…ë ¥ ì™„ë£Œ")

if not submitted:
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ê³¼ëª© ì„ íƒ + í™˜ê²½ì„¤ì • (secrets ê¸°ë°˜)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
course_options = {
    "êµìœ¡ê³µí•™": "1a2B3C_edu_folder_id",
    "êµìœ¡ì‹¬ë¦¬": "2d3E4F_psych_folder_id",
    "í•™ìŠµê³¼í•™": "PASTE_YOUR_ACTUAL_FOLDER_ID_HERE"
}

course_name = st.selectbox("ğŸ“ ì˜¤ëŠ˜ ë“¤ì„ ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”", list(course_options.keys()))
folder_id = course_options[course_name]

semester_start = datetime.strptime(st.secrets["semester_start"], "%Y-%m-%d").date()
key_dict = json.loads(st.secrets["gcp_tts_key"])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ì£¼ì°¨ ê³„ì‚° ë° Drive í…ìŠ¤íŠ¸ ì¶”ì¶œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
today = datetime.today()
week_no = get_current_week(semester_start, today.date())

st.info(f"ğŸ“… ì˜¤ëŠ˜ì€ {today.strftime('%Y-%m-%d')} / í•™ê¸° {week_no}ì£¼ì°¨ì…ë‹ˆë‹¤.\nğŸ“˜ ì„ íƒí•œ ê³¼ëª©: {course_name}")

with st.spinner("ğŸ“‚ ê°•ì˜ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤..."):
    drive_service = get_drive_service_from_secrets(key_dict)

    # ğŸ“‚ í´ë” ë‚´ë¶€ ë””ë²„ê¹… ë³´ê¸°
    with st.expander("ğŸ“ í´ë” ë‚´ë¶€ íŒŒì¼ í™•ì¸"):
        result = drive_service.files().list(
            q=f"'{folder_id}' in parents and trashed = false",
            fields="files(id, name, mimeType)"
        ).execute()
        for f in result.get("files", []):
            st.markdown(f"- **{f['name']}** ({f['mimeType']})")

    # ì£¼ì°¨ë³„ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    last_text, this_text = get_weekly_files(drive_service, folder_id, week_no)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. í…ìŠ¤íŠ¸ í™•ì¸ (ë””ë²„ê¹… ë° ë¸Œë¦¬í•‘ ì „ìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if last_text:
    st.subheader("ğŸ“„ ì§€ë‚œì£¼ì°¨ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°")
    st.text_area("Last Week Text", last_text, height=200)

if this_text:
    st.subheader("ğŸ“„ ì´ë²ˆì£¼ì°¨ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°")
    st.text_area("This Week Text", this_text, height=200)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. GPT ìš”ì•½ ë° ì˜¤ë””ì˜¤ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if last_text and this_text:
    st.success("âœ… ìë£Œ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ!")

    # GPT ìš”ì•½ ìƒì„±
    last_brief, this_brief = generate_brief(
        user_name=user_name,
        user_grade=user_grade,
        user_major=user_major,
        user_style=user_style,
        last_week_text=last_text,
        this_week_text=this_text,
        subject_name=course_name
    )

    # ì˜¤ë””ì˜¤ ìƒì„±
    audio_last = text_to_audio(last_brief)
    audio_last.seek(0)
    audio_this = text_to_audio(this_brief)
    audio_this.seek(0)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6. ì˜¤ë””ì˜¤ ì¬ìƒ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("### ğŸ” ì§€ë‚œì£¼ì°¨ ë³µìŠµ ë¸Œë¦¬í•‘")
    st.audio(audio_last, format="audio/mp3")

    st.markdown("### ğŸ”® ì´ë²ˆì£¼ì°¨ ì˜ˆìŠµ ë¸Œë¦¬í•‘")
    st.audio(audio_this, format="audio/mp3")

else:
    st.warning("âš ï¸ í•´ë‹¹ ì£¼ì°¨ì˜ ê°•ì˜ìë£Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í´ë”ëª… ë˜ëŠ” íŒŒì¼ëª…ì„ í™•ì¸í•˜ì„¸ìš”.")
