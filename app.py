# app.py

import streamlit as st
from datetime import datetime
from drive_handler import get_weekly_files, get_current_week
from auth_drive import authenticate_and_get_drive
from gpt_brief import generate_brief
from audio_utils import text_to_audio

# â–¶ï¸ ì„¤ì •ê°’
SEMESTER_START = datetime(2025, 3, 4).date()
DRIVE_FOLDER_ID = "YOUR_GOOGLE_DRIVE_FOLDER_ID"  # ìˆ˜ì • í•„ìš”

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. í•™ìŠµì ì •ë³´ ì…ë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.title("ğŸ§ ë°ì¼ë¦¬ í•™ìŠµ ë¸Œë¦¬í•‘ íŒŸìºìŠ¤íŠ¸")

with st.form("user_form"):
    st.subheader("ğŸ‘¤ í•™ìŠµì ì •ë³´ ì…ë ¥")
    user_name = st.text_input("ì´ë¦„")
    user_grade = st.selectbox("í•™ë…„", ["1í•™ë…„", "2í•™ë…„", "3í•™ë…„", "4í•™ë…„"])
    user_major = st.text_input("ì „ê³µ")
    user_style = st.selectbox("í•™ìŠµ ìŠ¤íƒ€ì¼", ["ê°œë… ì¤‘ì‹¬", "ì‚¬ë¡€ ì¤‘ì‹¬", "í‚¤ì›Œë“œ ìš”ì•½", "ìŠ¤í† ë¦¬í…”ë§"])
    submitted = st.form_submit_button("ì…ë ¥ ì™„ë£Œ")

if not submitted:
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Drive ì¸ì¦ ë° ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë°˜ ìë£Œ ë¶ˆëŸ¬ì˜¤ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
drive = authenticate_and_get_drive()
today = datetime.today()
today_week = get_current_week(SEMESTER_START, today.date())

st.info(f"ğŸ“… ì˜¤ëŠ˜ì€ {today.strftime('%Y-%m-%d')} / í•™ê¸° {today_week}ì£¼ì°¨ì…ë‹ˆë‹¤.")

with st.spinner("ğŸ“‚ ê°•ì˜ ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤..."):
    last_text, this_text = get_weekly_files(drive, today_week, folder_id=DRIVE_FOLDER_ID)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. GPT ìš”ì•½ ë° ì˜¤ë””ì˜¤ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if last_text and this_text:
    st.success("âœ… ìë£Œ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ!")

    # GPT ìš”ì•½
    last_brief, this_brief = generate_brief(
        user_name=user_name,
        user_grade=user_grade,
        user_major=user_major,
        user_style=user_style,
        last_week_text=last_text,
        this_week_text=this_text,
        subject_name="êµìœ¡ê³µí•™"
    )

    # TTS ì˜¤ë””ì˜¤ ìƒì„±
    audio_last = text_to_audio(last_brief)
    audio_last.seek(0)

    audio_this = text_to_audio(this_brief)
    audio_this.seek(0)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. ì˜¤ë””ì˜¤ ì¬ìƒ UI
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("### ğŸ” ì§€ë‚œì£¼ì°¨ ë³µìŠµ ë¸Œë¦¬í•‘")
    st.audio(audio_last, format="audio/mp3")

    st.markdown("### ğŸ”® ì´ë²ˆì£¼ì°¨ ì˜ˆìŠµ ë¸Œë¦¬í•‘")
    st.audio(audio_this, format="audio/mp3")

else:
    st.warning("í•´ë‹¹ ì£¼ì°¨ì˜ ê°•ì˜ ìë£Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
